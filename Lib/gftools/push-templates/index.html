<html>
	<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
		<style>
			html{font-family:sans-serif;}
	    h2 {
		display: block;
		font-size: 1.5em;
		margin-block-start: 0.83em;
		margin-block-end: 0.83em;
		margin-inline-start: 0px;
		margin-inline-end: 0px;
		font-weight: bold;
		margin-top: 48pt;
	    }
	    .nav {
		position: fixed;
		right: 30pt;
		top: 30pt;
	    }
		</style>
	</head>
    <body>
	<h1>Google Fonts Reporter</h1>
	<div class="nav">
	    <button data-duration="weekly">Weekly</button>
	    <button data-duration="monthly">Monthly</button>
	    <button data-duration="quarterly">Quarterly</button>
	    <button data-duration="annually">Annually</button>

	    <label for="start-date">Start:</label>
            <select name="start-date">
            {% for year in years %}
                {% if year == current_year-2 %}
                    <option selected="selected" value="{{ year }}">{{ year }}</option>
                {% else %}
                    <option value="{{ year }}">{{ year }}</option>
                {% endif %}
            {% endfor %}
            </select>

            <label for="end-date">End:</label>
            <select name="end-date">
            {% for year in years %}
                {% if year == current_year+1 %}
                    <option selected="selected" value="{{ year }}">{{ year }}</option>
                {% else %}
                    <option value="{{ year }}">{{ year }}</option>
                {% endif %}
            {% endfor %}
            </select>
	</div>
	<h2>Pushes</h2>
	<canvas id="commits-chart" width="800" height="450"></canvas>

	<h2>Contributors</h2>
	<canvas id="contributors-chart" width="800" height="450"></canvas>

	<h2>Issues</h2>
	<canvas id="issues-chart" width="800" height="450"></canvas>

    </body>
    <script>
var data = {{ commit_data|safe }}
var colors = [
    "#193B59", // blue
    "#BACAC0", // green
    "#F2D2B6", // yellow
    "#F2AD94", // orange
    "#F2AD94" // red
];


offsetDate = (date, duration) => {
    if (duration === "daily") {
        date.setHours(date.getHours() - 24);
    }
    else if (duration === "weekly") {
        date.setHours(date.getHours() - 24*7);
    }
    else if (duration === "monthly") {
        date.setMonth(date.getMonth() - 1);
    }
    else if (duration === "quarterly") {
        date.setMonth(date.getMonth() - 3);
    }
    else if (duration === "annually") {
        date.setYear(date.getFullYear() - 1);
    }
    else {
        throw "duration param is not correct!";
    }
    return date;

}

filterCommits = (data, start, end) => {
    res = [];
    for (i in data) {
	if (data[i]['date'] >= start && data[i]['date'] <= end) {
	    res.push(data[i]);
        }
    }
    return res;
}

contributorsGraphData = (commits, top) => {
    let res = {};
    for (i in commits) {
        let commit = commits[i];
        let author = commit['author'];
        if (!(author in res)) {
            res[author] = 0;
        }
        res[author] += 1;
    }
    var sorted = [];
    for (k in res) {
	sorted.push([k, res[k]]);
    }
    sorted.sort(function(a, b) {
	return b[1] - a[1]
    });
    sorted = sorted.slice(0, top);

    var labels = [];
    for (i in sorted) {
        labels.push(sorted[i][0]);
    }
    var data = [];
    for (i in sorted) {
        data.push(sorted[i][1]);
    }
    return {
	type: 'pie',
	data: {
	    labels: labels,
	    datasets: [{
		label: "Total commits",
		backgroundColor: colors,
		data: data
	    }]
	},
	options: {
	    title: {
		display: true,
		text: 'Total commits'
		}
	    }
    };
}


commitsGraphData = (data, duration) => {
    var delta = new Date(data[0]['date'])
    var label = delta.toDateString();
    let res = {};
    for (i in data) {
        let date = Date.parse(data[i]['date']);
	var label = delta.toISOString();
	if (date > delta) {
	    if (data[i]['kind'] === "family") {
		res[label]['family'] += 1;
	    } else if (data[i]['kind'] === 'metadata') {
		res[label]['metadata'] += 1;
	    } else if (data[i]['kind'] === 'designer') {
		res[label]['designer'] += 1;
	    } else if (data[i]['kind'] === 'infrastructure') {
		res[label]['infrastructure'] += 1;
	    }
	}
	else {
	    var delta = offsetDate(delta, duration);
	    var label = delta.toISOString();
	    res[label] = {"family": 0, "metadata": 0, "designer": 0, "infrastructure": 0};
	}
    }
    var keys = Object.keys(res).sort();
    var data = {
	"type": "line",
	"data": {
	    "labels": keys,
	    "datasets": [
		{
		    "data": [],
		    "label": "Designers",
		    "borderColor": colors[1],
		    lineTension: 0,  
		    borderCapStyle: "bevel",
		    "fill": false
		},
		{
		    "data": [],
		    "label": "Families",
		    "borderColor": colors[0],
		    lineTension: 0,  
		    borderCapStyle: "bevel",
		    "fill": false
		},
		{
		    "data": [],
		    "label": "Metadata",
		    "borderColor": colors[2],
		    lineTension: 0,  
		    borderCapStyle: "bevel",
		    "fill": false
		},
		{
		    "data": [],
		    "label": "Infrastructure",
		    "borderColor": colors[3],
		    lineTension: 0,  
		    borderCapStyle: "bevel",
		    "fill": false
		},
	    ] 
	},
	options: {
	    title: {
		display: true,
		text: 'Pull requests merged'
	    }
	}
    };
    for (i in keys) {
	var key = keys[i];
	var d = res[key];
	data['data']['datasets'][0]['data'].push(d['designer']);
	data['data']['datasets'][1]['data'].push(d['family']);
	data['data']['datasets'][2]['data'].push(d['metadata']);
	data['data']['datasets'][3]['data'].push(d['infrastructure']);
    }
    return data
}

issuesGraphData = (issues, duration) => {
    var delta = new Date(issues[0]['date'])
    var label = delta.toDateString();
    let res = {};
    for (i in issues) {
	let date = Date.parse(issues[i]['date']);
	var label = delta.toISOString();
	if (date > delta) {
	    if (issues[i]['closed'] === false) {
		res[label]['opened'] += 1
	    } else {
		res[label]['closed'] += 1
	    }
	}
	else {
	    console.log(duration)
	    var delta = offsetDate(delta, duration);
	    var label = delta.toISOString();
	    res[label] = {"opened": 0, "closed": 0};
	}
    }
    var keys = Object.keys(res).sort();
    var opened = [];
    var closed = [];
    for (i in keys) {
	var issue = res[keys[i]];
	opened.push(issue['opened'])
	closed.push(issue['closed'])
    }
    var data = {
	type: 'bar',
	data: {
	    labels: keys,
	    datasets: [
		{
		label: "Opened",
		backgroundColor: colors[0],
		data: opened
		}, {
		label: "Closed",
		backgroundColor: colors[2],
		data: closed
		}
	    ]
	},
	options: {
	    title: {
		display: true,
		text: 'Issues opened and closed'
	    }
	}
    }
    return data;
}


// init constants. TODO Use classes if this gets more complicated
duration = "quarterly"
startDate = document.getElementsByName("start-date")[0].value
endDate = document.getElementsByName("end-date")[0].value

commitsChart = null;
contributorsChart = null;
issuesChart = null;


buildCharts = (start, end, duration) => {
    var commits = filterCommits(data['commits'], start, end);
    var issues = filterCommits(data['issues'], start, end);
    
    if (commitsChart != null) {
        commitsChart.destroy();
        contributorsChart.destroy();
        issuesChart.destroy();
    }
    commitsChart = new Chart(document.getElementById("commits-chart"), commitsGraphData(commits, duration));
    contributorsChart = new Chart(document.getElementById("contributors-chart"), contributorsGraphData(commits, 7));
    issuesChart = new Chart(document.getElementById("issues-chart"), issuesGraphData(issues, duration));
}

const buttons = document.querySelectorAll('button');
buttons.forEach(elem => elem.addEventListener("click", function() {
    duration = elem.dataset.duration;
    buildCharts(startDate, endDate, duration)
}, false));

startDateBtn = document.getElementsByName("start-date")[0]
startDateBtn.addEventListener("change", function() {
    startDate = document.getElementsByName("start-date")[0].value;
    buildCharts(startDate, endDate, duration)
}, false);
endDateBtn = document.getElementsByName("end-date")[0]
endDateBtn.addEventListener("change", function() {
    endDate = document.getElementsByName("end-date")[0].value;
    buildCharts(startDate, endDate, duration)
}, false);

buildCharts(startDate, endDate, duration);

</script>
</html>